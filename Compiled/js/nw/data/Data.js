OJ.importJs("nw.app.AppManager");OJ.importJs("nw.data.DataEvent");OJ.importJs("nw.data.properties.Property");OJ.importJs("nw.data.properties.UuidProperty");OJ.importJs("nw.net.UrlLoader");OJ.importJs("oj.events.Actionable");OJ.importJs("oj.utils.Uuid");"use strict";OJ.extendClass(OjActionable,"NwData",{_post_compile_:function(c){NwData.registerDataType(this._static.TYPE,this._class_name);var d=this._static.DEFINITION,e=this._static.EXPORT_MAP,a=this._static.IMPORT_MAP,b;for(b in d){if(e[b]){a[e[b]]=b}d[b].setup(this,b,b.ucFirst())}this._static.CACHE={}},_data:null,_dirty:null,_keyword_cache:null,_loader:null,_is_loaded:false,_constructor:function(){this._super("NwData","_constructor",[]);this._data={};this._dirty=[];this._keyword_cache={};var a=arguments.length;if(a){this._prevent_dispatch=true;this.importData(arguments[0],a>1?arguments[1]:NwData.DEFAULT);this._prevent_dispatch=false}},_addToDirty:function(a){if(this._dirty&&this._dirty.indexOf(a)==-1){this._dirty.push(a)}},_exportValue:function(b,a){if(this._static.hasProperty(b)){return this._static.DEFINITION[b].exportValue(this._data[b],a)}return this._data[b]},_getDeleteRequest:function(d){var a=Array.prototype.splice.call(arguments,0);if(a.length<2){var c={};c[this._static.PRIMARY_KEY]=this.primarKey();a.push(c)}var b=this._getRequest(this._translateDeleteParam,a);b.getRequest().setType(OjUrlRequest.POST);return b},_getLoadRequest:function(c){var a=Array.prototype.splice.call(arguments,0);if(a.length<2){var b={};b[this._static.PRIMARY_KEY]=this.primaryKey();a.push(b)}return this._getRequest(this._translateLoadParam,a)},_getRequest:function(a,b){if(b.length>1){var c,e,d={};for(c in b[1]){e=a.call(this,c);if(e){d[e]=this._exportValue(c,NwData.API)}}b[1]=d}return AppManager.apiRequest.apply(AppManager,b)},_getSaveRequest:function(e){var a=Array.array(arguments);if(a.length<2){if(this.isNew()){a.push(Object.clone(this._data))}else{var b=this._dirty.length,d={};d[this._static.PRIMARY_KEY]=this.primaryKey();for(;b--;){d[this._dirty[b]]=this._data[this._dirty[b]]}a.push(d)}}var c=this._getRequest(this._translateSaveParam,a);c.getRequest().setMethod(OjUrlRequest.POST);return c},_importValue:function(e,c,d){if(this._static.hasProperty(e)){var b="set"+e.ucFirst();c=this._static.DEFINITION[e].importValue(c,this.property(e),d);if(b!="setnull"&&this[b]){this[b](c)}else{this.property(e,c)}if(d==NwData.API){var a=this._dirty.indexOf(e);if(a!=-1){this._dirty.splice(a,1)}}}},_processDeleteData:function(a){},_processLoadData:function(a){this.importData(a,NwData.API)},_processSaveData:function(a){this.importData(a,NwData.API)},_resetLoader:function(){if(this._loader){this._loader.cancel();this._loader=null}},_translateDeleteParam:function(b){var a=this._static.EXPORT_MAP;return a[b]?a[b]:b},_translateLoadParam:function(b){var a=this._static.EXPORT_MAP;return a[b]?a[b]:b},_translateSaveParam:function(b){var a=this._static.EXPORT_MAP;return a[b]?a[b]:b},_onDelete:function(a){this._is_loaded=false;this.primaryKey(null);this._processDeleteData(this._loader.getData());this._unset("_loader");this.dispatchEvent(new NwDataEvent(NwDataEvent.DELETE));this._static.dispatchEvent(new NwDataEvent(NwDataEvent.DELETE,this))},_onDeleteFail:function(a){this._unset("_loader");this.dispatchEvent(new NwDataEvent(NwDataEvent.DELETE_FAIL));this._static.dispatchEvent(new NwDataEvent(NwDataEvent.DELETE_FAIL,this))},_onLoad:function(a){this._is_loaded=true;this._processLoadData(this._loader.getData());this._unset("_loader");this.dispatchEvent(new NwDataEvent(NwDataEvent.LOAD));this._static.dispatchEvent(new NwDataEvent(NwDataEvent.LOAD,this))},_onLoadFail:function(a){this._unset("_loader");this.dispatchEvent(new NwDataEvent(NwDataEvent.LOAD_FAIL));this._static.dispatchEvent(new NwDataEvent(NwDataEvent.LOAD_FAIL,this))},_onSave:function(a){if(a){var d=a.getTarget();this._processSaveData(d.getData());var b,c,e=d.getRequest().getData(),f=this._static.EXPORT_MAP;for(c in e){b=this._dirty.indexOf(f[c]);if(b!=-1){this._dirty.splice(b,1)}}if(this._loader==d){this._unset("_loader")}}this.dispatchEvent(new NwDataEvent(NwDataEvent.SAVE,this));this._static.dispatchEvent(new NwDataEvent(NwDataEvent.SAVE,this))},_onSaveFail:function(a){if(a){this._unset("_loader")}this.dispatchEvent(new NwDataEvent(NwDataEvent.SAVE_FAIL,this));this._static.dispatchEvent(new NwDataEvent(NwDataEvent.SAVE_FAIL,this))},date:function(){return new Date()},"delete":function(){this._resetLoader();this._loader=this._getDeleteRequest();this._loader.addEventListener(OjEvent.COMPLETE,this,"_onDelete");this._loader.addEventListener(OjEvent.FAIL,this,"_onDeleteFail");this._loader.load()},exportData:function(){var a,b,e,f=arguments.length?arguments[0]:NwData.DEFAULT,d=f==NwData.DEFAULT,c=this._static.EXPORT_MAP;if(d){e=this._super("NwData","exportData",arguments)}else{e={};if(!this.isNew()){e[this._static.PRIMARY_KEY]=this.primaryKey()}}for(a in this._data){b=c[a]?c[a]:a;if(d||this._dirty.indexOf(a)!=-1){e[b]=this._exportValue(a,f)}}return e},importData:function(b){var a,d=arguments.length>1?arguments[1]:NwData.DEFAULT,c=this._static.IMPORT_MAP;for(a in b){this._importValue(c[a]?c[a]:a,b[a],d)}},isDirty:function(){return this._dirty.length>0},isLoaded:function(){return this._is_loaded},isNew:function(){return isEmpty(this.primaryKey())},primaryKey:function(){if(arguments.length){this.property(this._static.PRIMARY_KEY,arguments[0])}return this._data[this._static.PRIMARY_KEY]},keywordScore:function(a){var c=[],e=0;if(isArray(a)){c=a}else{c.push(a)}var b,d=c.length;while(d-->0){for(b in this._keyword_cache){if(this._keyword_cache[b]){e+=this._keyword_cache[b].count(c[d].toLowerCase())/(d+1)}}}return e},load:function(){this._resetLoader();this._is_loaded=false;this._loader=this._getLoadRequest();this._loader.addEventListener(OjEvent.COMPLETE,this,"_onLoad");this._loader.addEventListener(OjEvent.FAIL,this,"_onLoadFail");this._loader.load(this._getLoadRequest())},property:function(f){var b=arguments,c=this._data[f];if(b.length>1){var e=b[1];if(c!=e){this._addToDirty(f);var a=new NwDataEvent(NwDataEvent.CHANGE,e,c);this._data[f]=e;var d=this._static.DEFINITION;if(d&&d[f]&&d[f].is("OjTextProperty")){this._keyword_cache[f]=value?value.toLowerCase():null}this.dispatchEvent(a)}}return c},save:function(){if(!this.isNew()&&isEmpty(this._dirty)){this._onSave(null);return}this._resetLoader();this._loader=this._getSaveRequest();this._loader.addEventListener(OjEvent.COMPLETE,this,"_onSave");this._loader.addEventListener(OjEvent.FAIL,this,"_onSaveFail");this._loader.load()},title:function(){return null},getId:function(){return this._data.id},setId:function(a){var b=this.getId();if(b){delete this._static.CACHE[b]}this.property("id",a);if(a){this._static.CACHE[a]=this}}},{API:"api",DEFAULT:"default",CACHE:{},DEFINITION:{id:new NwUuidProperty()},EXPORT_MAP:{},IMPORT_MAP:{},PRIMARY_KEY:"id",TYPE:"Data",TYPES:{},_callApi:function(a,c,f,d,e){var b=AppManager.apiRequest(a,c,f);b.addEventListener(OjEvent.COMPLETE,this,d);b.addEventListener(OjEvent.FAIL,this,e);b.load();return b},_onApiFail:function(a,c,b){if(a){OJ.destroy(a)}this.dispatchEvent(new NwDataEvent(b,c))},_onApiLoad:function(a,e,b,c){if(a){var f=this.importData(a.getTarget().getData());if(b){this[e][b]=f}else{this[e]=f}OJ.destroy(a)}this.dispatchEvent(new NwDataEvent(c,b?this[e][b]:this[e]))},addEventListener:function(b,a,c){EventManager.addEventListener(this,b,a,c)},dispatchEvent:function(a){if(this._prevent_dispatch){return}EventManager.dispatchEvent(this,a)},get:function(d){if(!this.CACHE[d]){var b=this;var a=new b();a.setId(d)}return this.CACHE[d]},getProperty:function(a){return this.DEFINITION[a]},hasEventListener:function(a){return EventManager.hasEventListener(this,a)},hasProperty:function(a){return !isUndefined(this.DEFINITION[a])},id:function(){if(!this.CLASS_NAME){this.CLASS_NAME=OJ.classToString(this)}return this.CLASS_NAME},importData:function(d){var a=arguments,f=a.length>1?a[1]:NwData.DEFAULT;if(isArray(d)){var b=d.length;while(b-->0){d[b]=this.importData(d[b],f)}return d}if(isObject(d)){var h=d._class_name?OJ.stringToClass(d._class_name):this;if(h){var e,g=d[this.PRIMARY_KEY];if(g&&h.CACHE[g]){e=h.CACHE[g]}else{e=new h()}e.importData(d,f);return e}}return null},load:function(b){if(!b){return null}var a=this.get(b);if(a.isLoaded()&&(arguments.length==1||!arguments[1])){this.dispatchEvent(new NwDataEvent(NwDataEvent.LOAD,a))}else{a.load()}return a},registerDataType:function(a,b){if(!NwData.TYPES[a]){NwData.TYPES[a]=b}},removeAllListeners:function(){return EventManager.removeAllListeners(this)},removeEventListener:function(b,a,c){EventManager.removeEventListener(this,b,a,c)},typeToClass:function(a){if(NwData.TYPES[a]){return OJ.stringToClass(NwData.TYPES[a])}return null},uuid:function(){return uuid.v4()}});