OJ.importJs("oj.data.Collection");OJ.importJs("oj.components.Component");OJ.importJs("oj.events.CollectionEvent");OJ.importJs("oj.events.StackEvent");OJ.importJs("oj.fx.Easing");OJ.importJs("oj.fx.Fade");OJ.importJs("oj.fx.Move");OJ.importJs("oj.fx.Resize");OJ.importJs("oj.fx.transition");OJ.importJs("oj.fx.TweenSet");OJ.importCss("oj.nav.Stack");"use strict";OJ.extendComponent(OjComponent,"OjStack",OJ.implementInterface(OjICollection,{_props_:{active:null,activeIndex:-1,allowLooping:false,autoSizeHeight:false,autoSizeWidth:false,controller:null,transition:null,views:null},_current_index:0,_deferred_index:null,_prev_active:null,_prev_index:-1,_trans_in:null,_trans_out:null,_constructor:function(){this._super("OjStack","_constructor",arguments);this._elm_funcs={addElm:"addItem",addElmAt:"addItemAt",getElmAt:"getItemAt",getElms:"getItems",hasElm:"hasItem",indexOfElm:"indexOfItem",moveElm:"moveItem",numElms:"numItems",removeAllElms:"removeAllItems",removeElm:"removeItem",removeElmAt:"removeItemAt",replaceElm:"replaceItem",replaceElmAt:"replaceItemAt"};var a=arguments,b=a.length;this.setViews(b?a[0]:[]);this.setTransition(b>1?a[1]:OjTransition.NONE)},_destructor:function(){var a=arguments,c=a.length&&a[0];this._removeViewsListeners();this._unset("_trans_in",true);this._unset("_trans_out",true);if(this._prev_active){this._removeActive(this._prev_active);this._prev_active.setStack(null);this._prev_active.setController(null);this._prev_active=null}if(this._active){this._removeActive();this._active.setStack(null);this._active.setController(null);this._active=null}if(c>1){var b=this.numElms();for(;b--;){OJ.destroy(this.getElmAt(b),c)}}this._controller=this._transition=this._views=null;return this._super("OjStack","_destructor",arguments)},_setElmFuncs:function(a){},_callElmFunc:function(e,b){if(!this._elm_funcs[e]){return}var d=this._transition,a=-1;switch(e){case"removeAllElms":a=0;break;case"addElm":case"removeElm":case"removeElmAt":a=1;break;case"addElmAt":case"moveElm":case"replaceElm":case"replaceElmAt":a=2;break}if(a>-1){if(b.length>a){this.setTransition(this._processTransParam(b[a]));b.pop()}}var c=this._views[this._elm_funcs[e]].apply(this._views,b);if(a>-1){this.setTransition(d)}return c},_addActive:function(){var a=arguments.length?arguments[0]:this.getElmAt(this._activeIndex);a.setIsActive(true);this.container.addChild(a)},_animationDirection:function(b,a){return b<a?-1:1},_createTransIn:function(c,b){var a=0;switch(this._transition.getEffect()){case OjTransition.FADE:c.setX(0);c.setY(0);if(this._prev_active){return null}a=1;break;case OjTransition.SLIDE_HORZ:c.setX(-1*b*this.container.getWidth());break;case OjTransition.SLIDE_VERT:c.setY(-1*b*this.container.getHeight());break}return this._transition.make(c,OjTransition.IN,a)},_createTransOut:function(c,b){var a=0;switch(this._transition.getEffect()){case OjTransition.SLIDE_HORZ:a=c.getX()+(b*this.container.getWidth());break;case OjTransition.SLIDE_VERT:a=c.getY()+(b*this.container.getHeight());break}return this._transition.make(c,OjTransition.OUT,a)},_processTransParam:function(a){if(!a){return OjStack.NONE}if(a===true){return this._transition}return a},_removeActive:function(){var a=arguments,b=a.length?a[0]:this.getElmAt(this._activeIndex);b.setIsActive(false);this.container.removeChild(b)},_removeViewsListeners:function(){this._views.removeEventListener(OjCollectionEvent.ITEM_ADD,this,"_onItemAdd");this._views.removeEventListener(OjCollectionEvent.ITEM_MOVE,this,"_onItemMove");this._views.removeEventListener(OjCollectionEvent.ITEM_REMOVE,this,"_onItemRemove");this._views.removeEventListener(OjCollectionEvent.ITEM_REPLACE,this,"_onItemReplace")},_onItemAdd:function(a){this.dispatchEvent(new OjStackEvent(OjStackEvent.ADD,a.getItem(),this._transition,a.getIndex()));if(!this._active){this.setActiveIndex(a.getIndex())}else{this._current_index=this.indexOfElm(this._active)}},_onItemMove:function(a){this.dispatchEvent(new OjStackEvent(OjStackEvent.MOVE,a.getItem(),this._transition,a.getIndex()));if(this._active==a.getItem()){this._current_index=a.getIndex()}},_onItemRemove:function(a){this.dispatchEvent(new OjStackEvent(OjStackEvent.REMOVE,a.getItem(),this._transition,a.getIndex()));var c=a.getItem();if(this._active==c){var b;if(this._current_index){this.setActiveIndex(this._current_index-1)}else{if(b=this.numElms()){this.setActiveIndex(b-1)}else{this._active=null;this._current_index=-1}}}else{if(this._prev_active==c){this._prev_active=null}this._current_index=this.indexOfElm(this._active)}},_onItemReplace:function(a){this.dispatchEvent(new OjStackEvent(OjStackEvent.REPLACE,a.getItem(),this._transition,a.getIndex()));if(this._activeIndex==a.getIndex()){this._removeActive();this._addActive(this._active=a.getItem())}},_onTransIn:function(a){this._unset("_trans_in");this._setIsAnimating(false);this.dispatchEvent(new OjStackEvent(OjStackEvent.CHANGE_COMPLETE,this._active,this._transition,this._activeIndex,this._prev_index));if(!isNull(this._deferred_index)){this.setActiveIndex(this._deferred_index)}},_onTransOut:function(a){this._prev_active.removeClasses("prev-active");this._removeActive(this._prev_active);this._prev_active.setWidth(OjStyleElement.AUTO);this._prev_active.setHeight(OjStyleElement.AUTO);this._prev_active.setStack(null);this._prev_active.setController(null);this._unset("_trans_out");this._prev_active=null},next:function(){this.setActiveIndex(this._current_index+1)},prev:function(){this.setActiveIndex(this._current_index-1)},setActive:function(a){if((arguments[0]=this.indexOfElm(a))>-1){this.setActiveIndex.apply(this,arguments)}},setActiveIndex:function(g){var c=this._transition,f=arguments.length>1;if(f){this.setTransition(this._processTransParam(arguments[1]))}if(this._current_index==g&&this._active){return}if(this._trans_in){this._deferred_index=g;return}this._deferred_index=null;var i,b=null,d=null,e=null;this._current_index=g;this._prev_index=-1;if(this._active){this._prev_index=this._activeIndex;this._prev_active=this._active;e=this._animationDirection(this._prev_index,g);if(this._trans_out=this._createTransOut(this._prev_active,e)){this._prev_active.addClasses("prev-active");this._trans_out.addEventListener(OjTweenEvent.COMPLETE,this,"_onTransOut");this._trans_out.start()}this._active.unload()}else{this._unset("_trans_out")}if(!this.numElms()){this._activeIndex=0;this._current_index=0;this._active=null;return}var a=new OjStackEvent(OjStackEvent.CHANGE,i=this.getElmAt(this._activeIndex=g),this._transition,g,this._prev_index);(this._active=i).setStack(this);i.setController(this._controller);this._active.load();this._addActive(i);if(this._trans_out){if(e&&(this._trans_in=this._createTransIn(i,e))){this._trans_in.addEventListener(OjTweenEvent.COMPLETE,this,"_onTransIn");this._trans_in.start()}this._setIsAnimating(true)}else{if(this._prev_active){this._removeActive(this._prev_active)}}if(f){this.setTransition(c)}this.dispatchEvent(a)},setAllowLooping:function(a){if(this._allowLooping==a){return}if(!(this._allowLooping=a)){var b=this.numElms();if(this._current_index<0){this.setActiveIndex((b-this._current_index)%b)}else{if(this._current_index>=b){this.setActiveIndex(this._current_index%b)}}}},setController:function(a){if(this._controller==a){return}this._controller=a;a.setStack(this);if(this._active){this._active.setController(a)}},setTransition:function(a){if(this._transition==a){return}this._transition=OjTransition.transition(a,this._transition)},setViews:function(a){if(this._views==a){return}if(this._views){this._removeViewsListeners()}this._views=OjCollection.collection(a);this._views.addEventListener(OjCollectionEvent.ITEM_ADD,this,"_onItemAdd");this._views.addEventListener(OjCollectionEvent.ITEM_MOVE,this,"_onItemMove");this._views.addEventListener(OjCollectionEvent.ITEM_REMOVE,this,"_onItemRemove");this._views.addEventListener(OjCollectionEvent.ITEM_REPLACE,this,"_onItemReplace");this._current_index=-1;this.setActiveIndex(this._activeIndex)}}),{_TAGS:["stack"]});